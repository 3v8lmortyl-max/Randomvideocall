<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2-Way WebRTC Video Call</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }
    video {
      width: 100%;
      max-width: 300px;
      margin: 10px;
      border: 2px solid #333;
      border-radius: 10px;
    }
    input, button {
      margin: 5px;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>2-Way WebRTC Video Call</h2>
  <p>Your Room ID: <span id="room-id-display">N/A</span></p>
  <input type="text" id="room-id" placeholder="Room ID" />
  <button onclick="createRoom()">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>
  <br>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>  <!-- Firebase -->  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>  <!-- WebRTC Logic -->  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBT0umyu-D_BC6KC_e07DhwqhbQB7dAs3Y",
      authDomain: "randomvideochat-af8bb.firebaseapp.com",
      databaseURL: "https://randomvideochat-af8bb-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "randomvideochat-af8bb",
      storageBucket: "randomvideochat-af8bb.firebasestorage.app",
      messagingSenderId: "162637738009",
      appId: "1:162637738009:web:25decd4fb7ff1900cafa88"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let localStream;
    let remoteStream;
    let peerConnection;
    const servers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' }
      ]
    };

    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    async function setupMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      remoteStream = new MediaStream();
      localStream.getTracks().forEach(track => localVideo.srcObject = localStream);
    }

    async function createRoom() {
      await setupMedia();
      document.getElementById("room-id-display").textContent = "...";

      const roomRef = db.ref('rooms').push();
      const roomId = roomRef.key;
      document.getElementById("room-id").value = roomId;
      document.getElementById("room-id-display").textContent = roomId;

      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        remoteVideo.srcObject = remoteStream;
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      await roomRef.set({ offer });

      roomRef.on('value', async snapshot => {
        const data = snapshot.val();
        if (data?.answer && !peerConnection.currentRemoteDescription) {
          const answerDesc = new RTCSessionDescription(data.answer);
          await peerConnection.setRemoteDescription(answerDesc);
        }
        if (data?.calleeCandidates) {
          data.calleeCandidates.forEach(async cand => {
            await peerConnection.addIceCandidate(new RTCIceCandidate(cand));
          });
        }
      });

      const callerCandidates = roomRef.child('callerCandidates');
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          callerCandidates.push(event.candidate.toJSON());
        }
      };
    }

    async function joinRoom() {
      await setupMedia();
      const roomId = document.getElementById('room-id').value;
      document.getElementById("room-id-display").textContent = roomId;

      const roomRef = db.ref(`rooms/${roomId}`);
      const roomSnapshot = await roomRef.get();
      const offer = roomSnapshot.val()?.offer;
      if (!offer) return alert('Room not found or offer missing');

      peerConnection = new RTCPeerConnection(servers);
      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
      peerConnection.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        remoteVideo.srcObject = remoteStream;
      };

      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      await roomRef.update({ answer });

      const calleeCandidates = roomRef.child('calleeCandidates');
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          calleeCandidates.push(event.candidate.toJSON());
        }
      };

      roomRef.child('callerCandidates').on('child_added', async snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        await peerConnection.addIceCandidate(candidate);
      });
    }
  </script></body>
</html>
